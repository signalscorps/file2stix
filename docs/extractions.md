# Extractions

file2stix extracts observables from text and translates them into STIX 2.1 Objects. This section of the documentation describes the templates of the STIX Objects created.

## STIX Support

file2stix only supports STIX version 2.1 [as defined by this specification](https://docs.oasis-open.org/cti/stix/v2.1/os/stix-v2.1-os.html).

## Identities (`identity`) SDOs

file2stix assigns a `created_by_ref` property to many Objects. 

By defaults the generic file2stix identity will be used. 

You can also change the Identity used by creating your own template file (see example `tests/stix_templates/custom_identity_good.yml`). 

This is passed using the `--user-identity-file` flag.

If you do modify the file make sure to follow the schema defined herel `tests/stix_templates/custom_identity_schema.yml`

Here are some of the common things that can cause error;

1. Keep the quotes (`""`) around values
2. Replace the UUID in the `id` property with your own or a randomly generated UUID v4. [Here is a generator you can use to do this](https://www.uuidgenerator.net/version4)
  * e.g. `identity--acf55024-6bbe-486f-a27a-7967559324f4` -> `identity--bf65f135-7876-4b4f-a48b-4cbd85e77e87`
3. Modify the `created` and `modified` dates, if needed. Be sure to keep the same date/time format `YYYY-DD-MMTHH:MM:SS.sssZ`
4. Update the `name` and `description` fields. If using special json characters be sure to escape them
5. The `identity_class` property [must match one shown here](https://docs.oasis-open.org/cti/stix/v2.1/os/stix-v2.1-os.html#_be1dktvcmyu)
6. The `sectors` property [must match one shown here](https://docs.oasis-open.org/cti/stix/v2.1/os/stix-v2.1-os.html#_oogrswk3onck)

## Report SDOs (`report`)

All individual data sources ingested or uploaded are represented as a unique [STIX Report SDO](https://docs.oasis-open.org/cti/stix/v2.1/cs01/stix-v2.1-cs01.html#_n8bjzg1ysgdq) that take the following structure;

```json
    {
      "type": "report",
      "spec_version": "2.1",
      "id": "report--<GENERATED BY STIX2 LIBRARY>",
      "created_by_ref": "identity--<IDENTITY ID>",
      "created": "<ITEM INGEST DATE>",
      "modified": "<ITEM INGEST DATE>",
      "name": "File converted: <FILENAME>",
      "published": "<ITEM INGEST DATE>",
      "report_types": ["threat-report"],
      "object_marking_refs": [
        "marking-definition--<TLP LEVEL SET>"
      ],
      "object_refs": ["<LIST OF ALL EXTRACTED OBJECTS>"],
      "external_references": [
        {
          "source_name": "file2stix",
          "description": "This object was created using file2stix from the Signals Corps.",
          "url": "https://github.com/signalscorps/file2stix"
        }
      ]
    }
```

Note, the `object_refs` contains all references that are referenced by objects in the report (SDOs, SROs, SCOs). This includes extracted objects (i.e. Indicator SDOs, Vulnerability SDOs, Software SCOs, Relationship SROs etc.).

## Relationship SROS (`relationship`)

There are two types of extractions in file2stix; default and custom. T

### Default extractions (Report and SDO)

In the case of default extractions, a Relationship between the extracted Object and Report SDO is created with the `relationship_type` equal to default-extract.

The `created_by_ref` is the Identity ID.

The `created` and `modified` dates match those in the linked Report Object.

Here is the structure of the SRO for default extractions;

```json
  {
    "type": "relationship",
    "spec_version": "2.1",
    "id": "relationship--<GENERATED BY STIX2 LIBRARY>",
    "created_by_ref": "identity--<USER IDENTITY ID>",
    "created": "<REPORT CREATED DATE>",
    "modified": "<REPORT CREATED DATE>",
    "relationship_type": "default-extract-from",
    "source_ref": "<EXTRACTED STIX OBSERVABLE ID>",
    "target_ref": "report--<REPORT OBJECT>",
    "external_references": [
      {
        "source_name": "file2stix",
        "description": "This object was created using file2stix from the Signals Corps.",
        "url": "https://github.com/signalscorps/file2stix"
      }
    ]
  }
```

### Custom extractions (Report and SDO)

Custom extractions have slightly different Relationship Objects created where the `relationship_type` equal to custom-extract, as follows;

```json
  {
    "type": "relationship",
    "spec_version": "2.1",
    "id": "relationship--<GENERATED BY STIX2 LIBRARY>",
    "created_by_ref": "identity--<USER IDENTITY ID>",
    "created": "<REPORT CREATED DATE>",
    "modified": "<REPORT CREATED DATE>",
    "relationship_type": "custom-extract-from",
    "source_ref": "<EXTRACTED STIX OBSERVABLE ID>",
    "target_ref": "report--<REPORT OBJECT>",
    "external_references": [
      {
        "source_name": "file2stix",
        "description": "This object was created using file2stix from the Signals Corps.",
        "url": "https://github.com/signalscorps/file2stix"
      }
    ]
  }
```

### SCO and SDO relationships

Many extractions that create Indicator Objects also create one or more SCOs. These are joined like so

```json
  {
    "type": "relationship",
    "spec_version": "2.1",
    "id": "relationship--<GENERATED BY STIX2 LIBRARY>",
    "created_by_ref": "identity--<USER IDENTITY ID>",
    "created": "<REPORT CREATED DATE>",
    "modified": "<REPORT CREATED DATE>",
    "relationship_type": "pattern-contains",
    "source_ref": "indicator--<EXTRACTED STIX INDICATOR ID>",
    "target_ref": "<EXTRACTED STIX SCO ID>",
    "external_references": [
      {
        "source_name": "file2stix",
        "description": "This object was created using file2stix from the Signals Corps.",
        "url": "https://github.com/signalscorps/file2stix"
      }
    ]
  }
```

## Confidence scoring

file2stix also optionally allows you to add the `confidence` property to all extracted Indicator SDOs. You can set confidence between 0 - 100.

[Consult the STIX 2.1 Specification for more information if you're unfamiliar with confidence scoring](https://docs.oasis-open.org/cti/stix/v2.1/os/stix-v2.1-os.html#_1v6elyto0uqg).

Confidence is passed using the `--confidence` flag.

## TLP (`marking-definition`)

The default TLP level assigned is `TLP:WHITE`. You can change the TLP level using the `--tlp-level` flag.

file2stix allows for `TLP:GREEN`, `TLP:AMBER`, `TLP:RED` and `TLP:WHITE` definitions to be used when adding Reports. 

This determines the [STIX marking-definition](https://docs.oasis-open.org/cti/stix/v2.1/os/stix-v2.1-os.html#_yd3ar14ekwrs), either;

* `TLP:WHITE` (`marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9`)
* `TLP:GREEN` (`marking-definition--34098fce-860f-48ae-8e50-ebd3cc5e41da`)
* `TLP:AMBER` (`marking-definition--f88d31f6-486f-44da-b317-01333bde0b82`)
* `TLP:RED` (`marking-definition--5e57c739-391a-4eb3-b6be-7d15ca92d5ed`)

The TLP value is reported in the `object_marking_refs` property for the STIX Report Object and all extracted Objects representing extracted Observables (except for ATT&CK or CAPEC, where generic MITRE Objects are used).

## Defanging

Defanging obfuscates indicators into a safer representations so that a user reading a report does not accidentally click on a malicious URL or inadvertently run malicious code. Many cyber threat intelligence reports shared electronically employ defanging.

Typical types of fanged Observables include IPv4 addresses (e.g. `1.1.1.1`), IPv6 addresses (e.g. `2001:0db8:85a3:0000:0000:8a2e:0370:7334`), domain names (e.g. `example.com`), URLs (e.g. `https://example.com/research/index.html`), email addresses (e.g. `example@example.com`), file extensions (e.g. `malicious.exe`), and directory paths (e.g. `C:\\Windows\\System32`).

Unfortunately, there is no universal standard for defanging, although there are some common methods. Some samples of defanging I have observed include the following:

* Wrapping one or more special characters in `[` `]`
  * e.g. `www[.]example[.]com`
  * e.g. `http[:]//example.com`
  * e.g. `http[://]example.com`
  * e.g. `1.1.1.1[/]24`
* Wrapping one or more special characters in `{` `}`
* Wrapping one or more special characters in `(` `)`
* Prefixing one or more special characters with `[`
  * e.g. `www[.example[.com`
  * e.g. `http[://example.com`
  * e.g. `http[://example.com`
* Prefixing one or more special characters with `\`
* Replacing `http` and `hxxp`
  * e.g. `hxxps://google.com`
* Replacing `.` with ` dot `
  * e.g. `example@example dot com`
  * e.g. `http://example dot com`
* Replacing `.` with `[dot]` (or  `(dot)`, or `{dot}`)
  * e.g. `example@example[dot]com`
* Replacing `@` with ` at `
  * e.g. `example at example.com`
* Replacing `@` with `[at]` (or  `(at)`, or `{at}`)
  * e.g. `example[at]example.com` 

Note, a combination of the above techniques are also commonly implemented used. For example replacing `.` with ` dot ` and replacing `@` with ` at ` for an email like so; fanged = `example at example dot com`, defanged = `example@example.com`

Another example using even more fanging technique combinations for a URL; fanged = `hxxps[:]//test\.example[.)com[/]path`, defanged = `https://test.example.com/path`

file2stix can be used to defang the following observable types

* ipv4
* ipv6
* domain
* url
* email-address

Defanging will only occur if the `--defang-observables` is set to `true` (by default it is `false`).

When set to true, all SCO Objects that have been defanged will contain the property `"defanged": true`.

For example;

```json
{
    "type": "email-addr",
    "spec_version": "2.1",
    "id": "email-addr--0e81edfb-25a5-5cb0-8cb0-fe9c5efb6257",
    "value": "example9@example.com`",
    "defanged": true
}
```

## Branding

By default file2stix will populate the `external_references` section of all SDOs and SROs with a reference to file2stix.

```json
"external_references": [
    {
        "source_name": "file2stix",
        "description": "This object was created using file2stix from the Signals Corps.",
        "url": "https://github.com/signalscorps/file2stix"
      }
```

It is possible to remove this by using the `--no-branding` flag.

## Warning Lists

Warning Lists identify potentially benign file2stix extractions. DO NOT BE CONFUSED by the name; Warning Lists in file2stix are the equivilant of whitelists in other products.

file2stix uses MISP Warning Lists (using [PyMISPWarningLists](https://github.com/MISP/PyMISPWarningLists)) to identify potential extractions that should be whitelisted using a custom Extension definition.

https://github.com/signalscorps/stix2-objects/blob/main/extension-definition/property-extension/warning-list-extension/extension-definition--c8ea5ecb-f4a3-45e7-94de-9b9ba05161af/20220101000000000.json

Extracted values that match a Warning List are still converted to STIX 2.1 Objects, however, will contain the custom property listing the Warning Lists the extracted value matches with and will also contain `indicator_types` = `benign`.

For example;

```json
{
    "type": "indicator",
    "spec_version": "2.1",
    "id": "indicator--fb715301-acf3-4add-a70a-2b96f5ac15f5",
    "created": "2022-09-07T06:18:21.997149Z",
    "modified": "2022-09-08T06:13:24.191194Z",
    "name": "Domain: google.com",
    "indicator_types": [
        "unknown",
        "benign"
    ],
    "pattern": "[ domain-name:value = 'google.com' ]",
    "pattern_type": "stix",
    "pattern_version": "2.1",
    "valid_from": "2022-09-07T06:18:21.997149Z",
    "object_marking_refs": [
        "marking-definition--613f2e26-407d-48c7-9eca-b8e91df99dc9"
    ],
    "extensions": {
        "extension-definition--c8ea5ecb-f4a3-45e7-94de-9b9ba05161af": {
            "extension_type": "property-extension",
            "warning_list_match": [
                {
                    "list_name": "Top 20 000 websites from Cisco Umbrella",
                    "list_url": "https://misp.github.io/misp-warninglists/lists/cisco_top20k/list.json",
                    "list_type": "misp"
                },
                {
                    "list_name": "Custom list with url",
                    "list_url": "https://example.com/list.json",
                    "list_type": "custom"
                },
                {
                    "list_name": "Custom list with local path",
                    "list_type": "custom"
                }
            ]
        }
    },
    "external_references": [
        {
            "source_name": "file2stix",
            "description": "This object was created using file2stix from the Signals Corps.",
            "url": "https://github.com/signalscorps/file2stix"
        }
    ]
}
```

Note, MISP Warning Lists contain a `type` value (defined in the Warning List JSON). file2stix treats each Warning List differently, depending on its type as follows;

* `string`: extracted observables must be exact match to Warning List value (e.g. warning list: google.com -> observable: google.com = match)
* `substring`: extracted observable must contain Warning List value (e.g. warning list: google -> observable: api.google.com = match)
* `hostname`: extracted observable must contain Warning List value
* `cidr`: extracted observable must be exact match to Warning List value
* `regex`: file2stix does not consider warning lists of type `regex`

It is possible to completely ignore extractions that match to warning lists (and not create a STIX Object from them) using the flag `--ignore-warninglist-observables`.

### Custom Warning Lists

You can also create your own Warning Lists. Custom Warning Lists must follow the [MISP Warning List schema](https://github.com/MISP/misp-warninglists/blob/main/schema.json).

An example of a custom warning list can be seen in `tests/file_inputs/custom_warning_lists/list.json`

Due to the way data is shared, only Reports marked TLP GREEN, TLP AMBER, or TLP RED can be used with custom warning lists. As TLP WHITE reports are shared without attribution, printing a Warning List name will not be enough for a downstream user to determine what/who/and where the Warning List came from.

You can either pass a custom warning list as a local file path to the warning list json, e.g. `tests/file_inputs/custom_warning_lists/list.json` or using a url, e.g. `http://www.example.com/custom_warning_lists/list.json`.

file2stix will first check the Warning List is in the expected MISP Warning List format. If not, it will return an error and will not process the file.

## Extracted Object logic

If the same Observable is identified more than once in the same report, only one extraction is made. For example, if 1.1.1.1 is seen 3 times in a report, only one Indicator SDO is created for it.

If using Observed or Sighting mode the Observed Data SDO will count the occurances of an observable in the report using the `number_observed` field.

Note, the settings passed to the command line also determine how the following object types are created;

### SROs

These are never reused, and unique to every report.

### SDOs

file2stix reuses SDO Indicator, Vulnerability and Location objects (for default extractions) and Attack Pattern, Campaign, Course of Action, Infrastructure, Intrusion Set, Malware, Threat Actor, Tool when the following properties match:

* confidence: different confidence scores cn (assigned with `--confidence` flag)
* user identity: can be custom (assigned with `--user-identity-file` flag)
* TLP: either white, green, amber, or red (assigned with `tlp-level` flag)
* branding: file2stix branding can be removed (assigned with `--no-branding` flag)
* custom warning list: users can assign their own warning list which will be reported in a custom extension inside each SDO (assigned with `--misp-custom-warning-list-file` flag).

Put another way, if the same combination of TLP, identity confidence, branding and warning list exists, a previously created object is updated, else a new one is created.

Observered Data SDOs are always unique.

In the case where an SDO is reused, the `modified` property is update to reflect the latest observation of the observable.

#### Example 1

To demonstrate how this works in practice, lets assume in report 1 an IPv4 address observable (`198.51.100.3`) is detected.

Assuming the IPv4 address (`198.51.100.3`) has not been saved as an IPv4 address SDO previously from a report with the same confidence, identity, TLP, branding and custom warning list settings, a new SDO would be created for it (in this case, lets give it `id` = `ff26c055-6336-5bc5-b98d-13d6226742dd`). 

The `created` and `modified` properties for this STIX Object would both have the same timestamp (the time of extraction).

If this IPv4 address (`198.51.100.3`) was later detected in another data source imported to file2stix and that report was created with the same confidence, identity, TLP, branding and custom warning list settings, the existing SDO would be used (and updated) to represent the extraction.

#### Example 2

Lets now imagine a third report was uploaded with `198.51.100.3` in it. However, this time the report is uploaded with a different TLP to the two previous reports described in example 1.

In this case, a brand new Indicator SDO would be created for this extraction.

If a fourth report was uploaded with `198.51.100.3` in it, with the same settings used for report 3, the same SDO created in report 3 would be reused.

This does not include SCOs (e.g. Software Objects). Here the existing Object would be used, but not updated (because they do not contain `created` or `modified` properties) ti.
 
### SCOs

SCOs use the `value` field as an ID Contributing property.

See the STIX spec for more; https://docs.oasis-open.org/cti/stix/v2.1/os/stix-v2.1-os.html#_q6l05xzpcdf

Therefore, SCOs do not contain branding, tlp, identity, confidence or warning list and therefore SCOs are always reused if the `value` field matches.

Take the examples 1 and 2 for SDOs above, in this case one ipv4-addr SCO for `198.51.100.3` would be created.

## Mode specific extractions

The type of Objects created during extraction depends on the mode used. file2stix offers two modes;

1. `analysis` (default): used during research to create STIX 2.1 Objects from general threat research
  * [View Analysis Mode documentation here](./extractions-analysis-mode.md)
2. `observed`: allows you to keep track of how many times you've seen an extraction in a report
  * [View Observed Mode documentation here](./extractions-observed-mode.md)
3. `sighting`: used to denote that extractions from a report represent real instances of an observable being seen in your environment (generally used for log inputs)
  * [View Sighting Mode documentation here](./extractions-sightings-mode.md)